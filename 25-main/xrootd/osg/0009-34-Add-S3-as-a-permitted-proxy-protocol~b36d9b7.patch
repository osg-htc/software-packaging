From 02d6a53171686df77f9db27b51159ea796ba52db Mon Sep 17 00:00:00 2001
From: Brian Bockelman <bbockelman@morgridge.org>
Date: Sat, 12 Jul 2025 07:20:21 -0500
Subject: [PATCH 09/11] [#34] Add S3 as a permitted proxy protocol

---
 src/XrdApps/XrdCpConfig.cc | 2 ++
 src/XrdApps/XrdCpFile.cc   | 3 ++-
 src/XrdApps/XrdCpFile.hh   | 2 +-
 src/XrdPss/XrdPssUtils.cc  | 2 +-
 4 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/XrdApps/XrdCpConfig.cc b/src/XrdApps/XrdCpConfig.cc
index 7f8e8702e..b4213c31c 100644
--- a/src/XrdApps/XrdCpConfig.cc
+++ b/src/XrdApps/XrdCpConfig.cc
@@ -386,6 +386,7 @@ do{while(optind < Argc && Legacy(optind)) {}
      &&  dstFile->Protocol != XrdCpFile::isStdIO
      &&  dstFile->Protocol != XrdCpFile::isXroot
      &&  dstFile->Protocol != XrdCpFile::isPelican
+     &&  dstFile->Protocol != XrdCpFile::isS3
      &&  (!Want(DoAllowHttp) && ((dstFile->Protocol == XrdCpFile::isHttp) ||
                                  (dstFile->Protocol == XrdCpFile::isHttps))))
         {FMSG(dstFile->ProtName <<"file protocol is not supported.", 22)}
@@ -905,6 +906,7 @@ void XrdCpConfig::ProcFile(const char *fname)
     else if (!((pFile->Protocol == XrdCpFile::isXroot) ||
                (pFile->Protocol == XrdCpFile::isXroots) ||
                (pFile->Protocol == XrdCpFile::isPelican) ||
+               (pFile->Protocol == XrdCpFile::isS3) ||
                (Want(DoAllowHttp) && ((pFile->Protocol == XrdCpFile::isHttp) ||
                                       (pFile->Protocol == XrdCpFile::isHttps)))))
                {FMSG(pFile->ProtName <<" file protocol is not supported.", 22)}
diff --git a/src/XrdApps/XrdCpFile.cc b/src/XrdApps/XrdCpFile.cc
index e1e5dc980..a87413906 100644
--- a/src/XrdApps/XrdCpFile.cc
+++ b/src/XrdApps/XrdCpFile.cc
@@ -56,7 +56,8 @@ XrdCpFile::XrdCpFile(const char *FSpec, int &badURL)
                            {"root://",   7, isXroot},
                            {"roots://",  8, isXroots},
                            {"http://",   7, isHttp},
-                           {"pelican://",  10, isPelican},
+                           {"pelican://", 10,  isPelican},
+                           {"s3://",     5, isS3},
                            {"https://",  8, isHttps}
                           };
    static int pTnum = sizeof(pTab)/sizeof(struct proto);
diff --git a/src/XrdApps/XrdCpFile.hh b/src/XrdApps/XrdCpFile.hh
index 03972c360..89b5d785c 100644
--- a/src/XrdApps/XrdCpFile.hh
+++ b/src/XrdApps/XrdCpFile.hh
@@ -38,7 +38,7 @@ class XrdCpFile
 public:
 
 enum PType {isOther = 0, isDir,    isFile, isStdIO,
-            isXroot,     isXroots, isHttp, isHttps, isPelican, isDevNull, isDevZero
+            isXroot,     isXroots, isHttp, isHttps, isPelican, isS3, isDevNull, isDevZero
            };
 
 XrdCpFile        *Next;         // -> Next file in list
diff --git a/src/XrdPss/XrdPssUtils.cc b/src/XrdPss/XrdPssUtils.cc
index 42f37534f..1e3241946 100644
--- a/src/XrdPss/XrdPssUtils.cc
+++ b/src/XrdPss/XrdPssUtils.cc
@@ -43,7 +43,7 @@ namespace
                {{ "https://", 8},  { "http://", 7},
                 { "roots://", 8},  { "root://", 7},
                 {"xroots://", 9},  {"xroot://", 8},
-                {"pelican://", 10}
+                {"pelican://", 10}, {"s3://", 5}
                };
    int pTNum = sizeof(pTab)/sizeof(pEnt);
    int xrBeg = 2;
-- 
2.47.3

