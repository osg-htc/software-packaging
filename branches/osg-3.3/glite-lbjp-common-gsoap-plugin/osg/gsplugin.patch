Index: glite-lbjp-common-gsoap-plugin-3.1.2/src/glite_gsplugin.c
===================================================================
--- glite-lbjp-common-gsoap-plugin-3.1.2.orig/src/glite_gsplugin.c	2010-08-06 09:36:27.000000003 -0500
+++ glite-lbjp-common-gsoap-plugin-3.1.2/src/glite_gsplugin.c	2012-07-27 19:08:37.000000003 -0500
@@ -136,22 +136,23 @@
 			      const char *cert,
 			      const char *key)
 {
-   edg_wll_GssStatus gss_code;
-   edg_wll_GssCred cred = NULL;
-   
-   int ret;
-
-   ret = edg_wll_gss_acquire_cred_gsi((char *)cert, (char *)key, &cred, &gss_code);
-   if (ret)
-	return get_error(ret, &gss_code, "failed to load GSI credentials", &ctx->error_msg);
+	edg_wll_GssStatus gss_code;
+	edg_wll_GssCred cred = NULL;
 
-   if (ctx->internal_credentials && ctx->cred != NULL)
-      edg_wll_gss_release_cred(&ctx->cred, NULL);
+	int ret;
+
+	ret = edg_wll_gss_acquire_cred_gsi((char *)cert, (char *)key, &cred, &gss_code);
+	if (ret) {
+		return get_error(ret, &gss_code, "failed to load GSI credentials", &ctx->error_msg);
+	}
 
-   ctx->cred = cred;
-   ctx->internal_credentials = 1;
+	if (ctx->internal_credentials && ctx->cred != NULL)
+		edg_wll_gss_release_cred(&ctx->cred, NULL);
 
-   return 0;
+	ctx->cred = cred;
+	ctx->internal_credentials = 1;
+
+	return 0;
 }
 
 void
@@ -236,8 +237,13 @@
 {
 	glite_gsplugin_Context	ctx;
 
-	ctx = ((int_plugin_data_t *)soap_lookup_plugin(soap, plugin_id))->ctx;
-	if ( ctx ) return ctx->error_msg;
+	int_plugin_data_t *plugin_data = (int_plugin_data_t *)soap_lookup_plugin(soap, plugin_id);
+	if ( plugin_data ) {
+		ctx = plugin_data->ctx;
+		if ( ctx ) return ctx->error_msg;
+	} else {
+		return "soap_lookup_plugin() failed";
+	}
 
 	return NULL;
 }
@@ -408,9 +414,11 @@
 
 
 	ctx = ((int_plugin_data_t *)soap_lookup_plugin(soap, plugin_id))->ctx;
-	if ( ctx->error_msg ) { free(ctx->error_msg); ctx->error_msg = NULL; }
+	if ( ctx->error_msg ) {
+		free(ctx->error_msg); ctx->error_msg = NULL;
+	}
 
-	if ( ctx->connection->context == NULL ) {
+	if ( ctx->connection == NULL || ctx->connection->context == NULL ) {
 		soap->errnum = ENOTCONN;
 		/* XXX: glite_gsplugin_send() returns SOAP_EOF on errors
 		 */
