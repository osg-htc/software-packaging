--- _build_results/BUILD/globus_gram_job_manager_setup_condor-4.4/condor.in	2011-08-08 07:43:49.000000000 -0500
+++ condor.in	2011-08-08 08:12:52.000000000 -0500
@@ -36,7 +36,7 @@
 
 @ISA = qw(Globus::GRAM::JobManager);
 
-my ($condor_submit, $condor_rm, $condor_config, $isNFSLite);
+my ($condor_submit, $condor_rm, $condor_config, $isNFSLite, $isManagedFork);
 
 BEGIN
 {
@@ -53,6 +53,7 @@
     }
 
     $isNFSLite = 0;
+    $isManagedFork = 0;
 }
 
 sub new
@@ -83,6 +84,12 @@
         }
     }
 
+    if ($description->servicetag() =~ m/^fork\./ ||
+         $description->servicetag() =~ m/^managedfork\./ )
+    {
+        $isManagedFork = 1;
+    }
+
     if (! exists($self->{condor_logfile}))
     {
         if(! exists($ENV{GLOBUS_SPOOL_DIR}))
@@ -139,14 +146,7 @@
     my ($condor_submit_out, $condor_submit_err);
     my $rc;
     my $scratch_isset = 0; # Flag if the SCRATCH_DIRECTORY environment variable is set indicating likely GRAM job
-
-    # Reject jobs that want streaming, if so configured
-    if ( $description->streamingrequested() &&
-	 $description->streamingdisabled() ) {
-
-	$self->log("Streaming is not allowed.");
-	return Globus::GRAM::Error::OPENING_STDOUT;
-    }
+    my $is_grid_monitor = 0;
 
     if($description->jobtype() eq 'single' ||
        $description->jobtype() eq 'multiple')
@@ -170,6 +170,10 @@
     {
 	return Globus::GRAM::Error::JOBTYPE_NOT_SUPPORTED();
     }
+    if ($isManagedFork)
+    {
+        $universe = 'local';
+    }
 
     # Validate some RSL parameters
     if(!defined($description->directory()))
@@ -212,6 +216,32 @@
 	}
     }
 
+    # Check if this is the Condor-G grid monitor
+    if ($isManagedFork)
+    {
+        my $exec = $description->executable();
+        my $file_out = `/usr/bin/file $exec`;
+        if ( $file_out =~ /script/ || $file_out =~ /text/ ||
+	     $file_out =~ m|/usr/bin/env| ) {
+	    open( EXEC, "<$exec" ) or
+ 	        return Globus::GRAM::Error::EXECUTABLE_PERMISSIONS();
+	    while( <EXEC> ) {
+	        if ( /Sends results from the grid_manager_monitor_agent back to a/ ) {
+		    $is_grid_monitor = 1;
+	        }
+ 	    }
+	    close( EXEC );
+        }
+    }
+
+    # Reject jobs that want streaming, if so configured
+    if ( $description->streamingrequested() &&
+         $description->streamingdisabled() && !$is_grid_monitor ) {
+    
+        $self->log("Streaming is not allowed.");
+        return Globus::GRAM::Error::OPENING_STDOUT;
+    }
+
     @environment = $description->environment();
 
     foreach my $tuple ($description->environment())
@@ -261,6 +291,13 @@
     }       
     # NFS Lite End
 
+    if ($isManagedFork)
+    {
+        append_path_array(\@environment, 'LD_LIBRARY_PATH', $ENV{LD_LIBRARY_PATH});
+        append_path_array(\@environment, 'PERL5LIB', $ENV{PERL5LIB});
+        append_path_array(\@environment, 'PATH', $ENV{PATH});
+    }
+
     $environment_string = join(';',
                                map {$_->[0] . "=" . $_->[1]} @environment);
 
@@ -378,6 +415,11 @@
 	$rank = "rank = Memory\n";
     }
 
+    if ($isManagedFork)
+    {
+        $requirements = "True";
+    }
+
     $rc = print SCRIPT_FILE "Requirements = $requirements\n";
     if (!$rc)
     {
@@ -466,6 +508,16 @@
             "print: $script_filename: $!",
             Globus::GRAM::Error::TEMP_SCRIPT_FILE_FAILED());
     }
+    if ( $is_grid_monitor ) {
+	$rc = print SCRIPT_FILE "+GridMonitorJob = True\n";
+        if (!$rc)
+        {
+            return $self->respond_with_failure_extension(
+                "print: $script_filename: $!",
+                Globus::GRAM::Error::TEMP_SCRIPT_FILE_FAILED());
+        }
+    }
+
     # NFS Lite mode
     if ($isNFSLite) {
         print SCRIPT_FILE "should_transfer_files = YES\n";
@@ -919,4 +971,17 @@
     return 1; # Should return a proper Globus success code
 }
 
+# Append to a path if it exists, create it if it does not
+sub append_path_array {
+    my ($arr_ref, $var, $path) = @_;
+    
+    foreach my $val (@$arr_ref) {
+        if($val->[0] eq "$var") {
+            $val->[1] .= ":$path";
+            return;
+        }
+    }
+    push @$arr_ref, [$var, $path];
+}
+
 1;
