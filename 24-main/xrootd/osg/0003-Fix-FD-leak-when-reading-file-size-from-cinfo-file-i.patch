From f7267c5c17c9c53f547100259201b0cf5ad4757d Mon Sep 17 00:00:00 2001
From: Brian Bockelman <bbockelman@morgridge.org>
Date: Wed, 15 Jan 2025 08:04:24 -0600
Subject: [PATCH 3/9] Fix FD leak when reading file-size from cinfo file in
 `Cache::DetermineFullFileSize()`.

---
 src/XrdPfc/XrdPfc.cc | 20 ++++++++++++++------
 1 file changed, 14 insertions(+), 6 deletions(-)

diff --git a/src/XrdPfc/XrdPfc.cc b/src/XrdPfc/XrdPfc.cc
index 86078fbdf..dffdd9847 100644
--- a/src/XrdPfc/XrdPfc.cc
+++ b/src/XrdPfc/XrdPfc.cc
@@ -944,13 +944,21 @@ long long Cache::DetermineFullFileSize(const std::string &cinfo_fname)
 
    XrdOssDF *infoFile = m_oss->newFile(m_configuration.m_username.c_str());
    XrdOucEnv env;
+   long long ret;
    int res = infoFile->Open(cinfo_fname.c_str(), O_RDONLY, 0600, env);
-   if (res < 0)
-      return res;
-   Info info(m_trace, 0);
-   if ( ! info.Read(infoFile, cinfo_fname.c_str()))
-      return -EBADF;
-   return info.GetFileSize();
+   if (res < 0) {
+      ret = res;
+   } else {
+      Info info(m_trace, 0);
+      if ( ! info.Read(infoFile, cinfo_fname.c_str())) {
+         ret = -EBADF;
+      } else {
+         ret = info.GetFileSize();
+      }
+      infoFile->Close();
+   }
+   delete infoFile;
+   return ret;
 }
 
 //______________________________________________________________________________
-- 
2.43.5

