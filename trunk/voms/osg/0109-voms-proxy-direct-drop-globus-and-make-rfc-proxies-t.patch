From c7047ff5b6bab579a04dae2ef365e1561cb17455 Mon Sep 17 00:00:00 2001
From: Matyas Selmeci <matyas@cs.wisc.edu>
Date: Wed, 14 Feb 2018 17:42:33 -0600
Subject: [PATCH] voms-proxy-direct: drop -globus and make rfc proxies the
 default

---
 doc/voms-proxy-direct.xml |  7 ++-----
 src/utils/vomsdirect.cc   | 28 ++++------------------------
 src/utils/vomsdirect.h    |  3 ---
 3 files changed, 6 insertions(+), 32 deletions(-)

diff --git a/doc/voms-proxy-direct.xml b/doc/voms-proxy-direct.xml
index 79d3f32..905dc84 100644
--- a/doc/voms-proxy-direct.xml
+++ b/doc/voms-proxy-direct.xml
@@ -106,16 +106,13 @@ The file containing the policy expression.</para>
 The language in which the policy is expressed. Default is IMPERSONATION_PROXY.</para>
 
 <para><option>-path-length</option>
 Maximum depth of proxy certfificate that can be signed from this.</para>
 
-<para><option>-globus</option><replaceable>  version</replaceable>
-Underlying Globus version.</para>
-
 <para><option>-proxyver</option>
-Version of the proxy certificate to create. May be 2 or 3.
-Default value is decided upon underlying globus version.</para>
+Version of the proxy certificate to create. May be 2, 3, or 4.
+Default value is 4 (RFC).</para>
 
 <para><option>-separate</option><replaceable>  file</replaceable>
 Saves the voms credential on file <emphasis remap='I'>file</emphasis>.</para>
 
 <para><option>-hostcert</option><replaceable>  file</replaceable>
diff --git a/src/utils/vomsdirect.cc b/src/utils/vomsdirect.cc
index a747d34..1034aa0 100644
--- a/src/utils/vomsdirect.cc
+++ b/src/utils/vomsdirect.cc
@@ -175,11 +175,11 @@ Direct::Direct(int argc, char ** argv) :   confile(conf_file_name),
                                        outfile(NULL),
                                        separate(""), uri(""),bits(-1),
                                        hours(12), limit_proxy(false),
                                        vomslife(-1), proxyver(0),
                                        pathlength(1), verify(false),
-                                       noregen(false), version(0),
+                                       noregen(false),
 #ifdef CLASS_ADD
                                        class_add_buf(NULL),
                                        class_add_buf_len(0),
 #endif
                                        ucert(NULL), upkey(NULL), cert_chain(NULL),
@@ -230,12 +230,11 @@ Direct::Direct(int argc, char ** argv) :   confile(conf_file_name),
     "    -include <file>                Include the contents of the specified file.\n" \
     "    -conf <file>                   Read options from <file>.\n" \
     "    -policy <policyfile>           File containing policy to store in the ProxyCertInfo extension.\n" \
     "    -pl, -policy-language <oid>    OID string for the policy language.\n" \
     "    -path-length <l>               Allow a chain of at most l proxies to be generated from this one.\n" \
-    "    -globus                        Globus version.\n" \
-    "    -proxyver <n>                  Version of proxy certificate.\n" \
+    "    -proxyver <n>                  Version of proxy certificate. Default 4 (RFC)\n" \
     "    -rfc                           Create RFC-conforming proxies (synonym of --proxyver 4)\n"
     "    -noregen                       Doesn't regenerate a new proxy for the connection.\n" \
     "    -separate <file>               Saves the information returned by the server into file <file>.\n" \
     "    -hostcert <file>               Host certificate used for signing the attributes.\n" \
     "    -hostkey <file>                Host private key used for signing the attributes.\n" \
@@ -283,11 +282,10 @@ Direct::Direct(int argc, char ** argv) :   confile(conf_file_name),
     {"quiet",           0, (int *)&quiet,       OPT_BOOL},
     {"pwstdin",         0, (int *)&pwstdin,     OPT_BOOL},
     {"conf",            1, NULL,                OPT_CONFIG},
     {"voms",            1, (int *)&voms,        OPT_STRING},
     {"target",          1, (int *)&targets,     OPT_MULTI},
-    {"globus",          1,        &version,     OPT_NUM},
     {"proxyver",        1,        &proxyver,    OPT_NUM},
     {"rfc",             0, (int *)&rfc,         OPT_BOOL},
     {"policy",          1, (int *)&policyfile,  OPT_STRING},
     {"policy-language", 1, (int *)&policylang,  OPT_STRING},
     {"pl",              1, (int *)&policylang,  OPT_STRING},
@@ -892,20 +890,10 @@ bool Direct::VerifyOptions()
 
     if (hostcert.empty() || hostkey.empty())
       exitError("Error: You must specify an host key!");
   }
 
-  /* set globus version */
-
-  version = globus(version);
-  if (version == 0) {
-    version = 22;
-    Print(DEBUG) << "Unable to discover Globus version: trying for 2.2" << std::endl;
-  }
-  else
-    Print(DEBUG) << "Detected Globus version: " << version << std::endl;
-
   if (rfc && proxyver != 0)
     exitError("Used both -rfc and --proxyver!\nChoose one or the other.");
 
   if (rfc)
     proxyver = 4;
@@ -913,20 +901,12 @@ bool Direct::VerifyOptions()
   /* set proxy version */
 
   if (proxyver!=2 && proxyver!=3 && proxyver!=4 && proxyver!=0)
     exitError("Error: proxyver must be 2 or 3 or 4");
   else if (proxyver==0) {
-    Print(DEBUG) << "Unspecified proxy version, settling on version: ";
-
-    if (version<30)
-      proxyver = 2;
-    else if (version<40)
-      proxyver = 3;
-    else
-      proxyver = 4;
-
-    Print(DEBUG) << proxyver << std::endl;
+    Print(DEBUG) << "Unspecified proxy version, settling on version 4 (RFC)" << std::endl;
+    proxyver = 4;
   }
 
   /* PCI extension option */
 
   if (proxyver>3) {
diff --git a/src/utils/vomsdirect.h b/src/utils/vomsdirect.h
index d21b09d..032b99d 100644
--- a/src/utils/vomsdirect.h
+++ b/src/utils/vomsdirect.h
@@ -78,13 +78,10 @@ class Direct {
   bool               verify;
 
   // doesn't regenerate proxy, use old
   bool               noregen;
 
-  // globus version
-  int                version;
-
   std::string        voms;
   std::string        targetlist;
   std::vector<std::string> fqans;
 
 #ifdef CLASS_ADD
-- 
2.6.3

