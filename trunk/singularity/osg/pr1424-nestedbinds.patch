From a47f15d98c47b3a6770f51bafa053955ea1a21bf Mon Sep 17 00:00:00 2001
From: Cedric Clerget <cedric.clerget@gmail.com>
Date: Tue, 27 Mar 2018 22:53:23 +0200
Subject: [PATCH 1/4] Don't create files or directories with nested binds. Add
 a base path argument to s_mkpath to check if created directory are within
 base path. Save and restore mount errno in singularity_mount.

---
 src/lib/runtime/files/libs/libs.c            |  4 ++--
 src/lib/runtime/mounts/binds/binds.c         |  9 +++++++--
 src/lib/runtime/mounts/dev/dev.c             |  8 ++++----
 src/lib/runtime/mounts/home/home.c           |  4 ++--
 src/lib/runtime/mounts/hostfs/hostfs.c       |  2 +-
 src/lib/runtime/mounts/scratch/scratch.c     |  4 ++--
 src/lib/runtime/mounts/tmp/tmp.c             |  4 ++--
 src/lib/runtime/mounts/userbinds/userbinds.c | 14 +++++++++-----
 src/lib/runtime/overlayfs/overlayfs.c        |  6 +++---
 src/util/daemon.c                            |  2 +-
 src/util/file.c                              | 28 ++++++++++++++++++++++++++--
 src/util/file.h                              |  2 +-
 src/util/mount.c                             | 22 +++++++++++++++++++---
 13 files changed, 79 insertions(+), 30 deletions(-)

diff --git a/src/lib/runtime/files/libs/libs.c b/src/lib/runtime/files/libs/libs.c
index 4d17665e3..e9538c633 100644
--- a/src/lib/runtime/files/libs/libs.c
+++ b/src/lib/runtime/files/libs/libs.c
@@ -75,7 +75,7 @@ int _singularity_runtime_files_libs(void) {
         }
 
         singularity_message(DEBUG, "Creating session libdir at: %s\n", libdir);
-        if ( s_mkpath(libdir, 0755) != 0 ) {
+        if ( s_mkpath(libdir, 0755, tmpdir) != 0 ) {
             singularity_message(ERROR, "Failed creating temp lib directory at: %s\n", libdir);
             ABORT(255);
         }
@@ -150,7 +150,7 @@ int _singularity_runtime_files_libs(void) {
             char *ld_path;
             singularity_message(DEBUG, "Attempting to create contained libdir\n");
             singularity_priv_escalate();
-            if ( s_mkpath(libdir_contained, 0755) != 0 ) {
+            if ( s_mkpath(libdir_contained, 0755, container_dir) != 0 ) {
                 singularity_message(ERROR, "Failed creating directory %s :%s\n", libdir_contained, strerror(errno));
                 ABORT(255);
             }
diff --git a/src/lib/runtime/mounts/binds/binds.c b/src/lib/runtime/mounts/binds/binds.c
index 1364c9414..eed4f040b 100644
--- a/src/lib/runtime/mounts/binds/binds.c
+++ b/src/lib/runtime/mounts/binds/binds.c
@@ -85,12 +85,17 @@ int _singularity_runtime_mount_binds(void) {
         if ( ( is_file(source) == 0 ) && ( is_file(joinpath(container_dir, dest)) < 0 ) ) {
             if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
                 char *basedir = dirname(joinpath(container_dir, dest));
+                char *dir = dirname(strdup(dest));
+                if ( strcmp(dir, "/") != 0 && check_mounted(dir) >= 0 ) {
+                    singularity_message(WARNING, "Nested bind detected, skip file creation\n");
+                    continue;
+                }
 
                 singularity_message(DEBUG, "Checking base directory for file %s ('%s')\n", dest, basedir);
                 if ( is_dir(basedir) != 0 ) {
                     singularity_message(DEBUG, "Creating base directory for file bind\n");
                     singularity_priv_escalate();
-                    if ( s_mkpath(basedir, 0755) != 0 ) {
+                    if ( s_mkpath(basedir, 0755, container_dir) != 0 ) {
                         singularity_message(ERROR, "Failed creating base directory to bind file: %s\n", dest);
                         ABORT(255);
                     }
@@ -120,7 +125,7 @@ int _singularity_runtime_mount_binds(void) {
             if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
                 singularity_priv_escalate();
                 singularity_message(VERBOSE3, "Creating bind directory on overlay file system: %s\n", dest);
-                if ( s_mkpath(joinpath(container_dir, dest), 0755) < 0 ) {
+                if ( s_mkpath(joinpath(container_dir, dest), 0755, container_dir) < 0 ) {
                     singularity_priv_drop();
                     singularity_message(WARNING, "Could not create bind point directory in container %s: %s\n", dest, strerror(errno));
                     continue;
diff --git a/src/lib/runtime/mounts/dev/dev.c b/src/lib/runtime/mounts/dev/dev.c
index 1b88ed46f..c8226227f 100644
--- a/src/lib/runtime/mounts/dev/dev.c
+++ b/src/lib/runtime/mounts/dev/dev.c
@@ -65,7 +65,7 @@ int _singularity_runtime_mount_dev(void) {
             }
 
             singularity_priv_escalate();
-            ret = s_mkpath(joinpath(container_dir, "/dev"), 0755);
+            ret = s_mkpath(joinpath(container_dir, "/dev"), 0755, container_dir);
             singularity_priv_drop();
 
             if ( ret < 0 ) {
@@ -75,13 +75,13 @@ int _singularity_runtime_mount_dev(void) {
         }
 
         singularity_message(DEBUG, "Creating temporary staged /dev\n");
-        if ( s_mkpath(devdir, 0755) != 0 ) {
+        if ( s_mkpath(devdir, 0755, NULL) != 0 ) {
             singularity_message(ERROR, "Failed creating the session device directory %s: %s\n", devdir, strerror(errno));
             ABORT(255);
         }
 
         singularity_message(DEBUG, "Creating temporary staged /dev/shm\n");
-        if ( s_mkpath(joinpath(devdir, "/shm"), 0755) != 0 ) {
+        if ( s_mkpath(joinpath(devdir, "/shm"), 0755, NULL) != 0 ) {
             singularity_message(ERROR, "Failed creating temporary /dev/shm %s: %s\n", joinpath(devdir, "/shm"), strerror(errno));
             ABORT(255);
         }
@@ -94,7 +94,7 @@ int _singularity_runtime_mount_dev(void) {
                 ABORT(255);
             }
             singularity_message(DEBUG, "Creating staged /dev/pts\n");
-            if ( s_mkpath(joinpath(devdir, "/pts"), 0755) != 0 ) {
+            if ( s_mkpath(joinpath(devdir, "/pts"), 0755, NULL) != 0 ) {
                 singularity_message(ERROR, "Failed creating /dev/pts %s: %s\n", joinpath(devdir, "/pts"), strerror(errno));
                 ABORT(255);
             }
diff --git a/src/lib/runtime/mounts/home/home.c b/src/lib/runtime/mounts/home/home.c
index ade585344..a6802138b 100644
--- a/src/lib/runtime/mounts/home/home.c
+++ b/src/lib/runtime/mounts/home/home.c
@@ -93,7 +93,7 @@ int _singularity_runtime_mount_home(void) {
     }
 
     singularity_message(DEBUG, "Creating temporary directory to stage home: %s\n", joinpath(session_dir, home_dest));
-    if ( s_mkpath(joinpath(session_dir, home_dest), 0755) < 0 ) {
+    if ( s_mkpath(joinpath(session_dir, home_dest), 0755, session_dir) < 0 ) {
         singularity_message(ERROR, "Failed creating home directory stage %s: %s\n", joinpath(session_dir, home_dest), strerror(errno));
         ABORT(255);
     }
@@ -145,7 +145,7 @@ int _singularity_runtime_mount_home(void) {
 
         singularity_priv_escalate();
         singularity_message(DEBUG, "Creating home directory within container: %s\n", joinpath(container_dir, home_dest));
-        if ( s_mkpath(joinpath(container_dir, home_dest), 0755) < 0 ) {
+        if ( s_mkpath(joinpath(container_dir, home_dest), 0755, container_dir) < 0 ) {
             singularity_message(ERROR, "Failed creating home directory in container %s: %s\n", joinpath(container_dir, home_dest), strerror(errno));
             ABORT(255);
         }
diff --git a/src/lib/runtime/mounts/hostfs/hostfs.c b/src/lib/runtime/mounts/hostfs/hostfs.c
index a8ce8a93d..0c4502e07 100644
--- a/src/lib/runtime/mounts/hostfs/hostfs.c
+++ b/src/lib/runtime/mounts/hostfs/hostfs.c
@@ -151,7 +151,7 @@ int _singularity_runtime_mount_hostfs(void) {
         if ( ( is_dir(mountpoint) == 0 ) && ( is_dir(joinpath(container_dir, mountpoint)) < 0 ) ) {
             if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
                 singularity_priv_escalate();
-                if ( s_mkpath(joinpath(container_dir, mountpoint), 0755) < 0 ) {
+                if ( s_mkpath(joinpath(container_dir, mountpoint), 0755, container_dir) < 0 ) {
                     singularity_priv_drop();
                     singularity_message(WARNING, "Could not create bind point directory in container %s: %s\n", mountpoint, strerror(errno));
                     continue;
diff --git a/src/lib/runtime/mounts/scratch/scratch.c b/src/lib/runtime/mounts/scratch/scratch.c
index 212049253..46b9efcf3 100644
--- a/src/lib/runtime/mounts/scratch/scratch.c
+++ b/src/lib/runtime/mounts/scratch/scratch.c
@@ -92,7 +92,7 @@ int _singularity_runtime_mount_scratch(void) {
         char *full_sourcedir_path = joinpath(sourcedir_path, basename(strdup(current)));
         char *full_destdir_path = joinpath(container_dir, current);
 
-        if ( s_mkpath(full_sourcedir_path, 0750) < 0 ) {
+        if ( s_mkpath(full_sourcedir_path, 0750, NULL) < 0 ) {
              singularity_message(ERROR, "Could not create scratch working directory %s: %s\n", full_sourcedir_path, strerror(errno));
              ABORT(255);
         }
@@ -101,7 +101,7 @@ int _singularity_runtime_mount_scratch(void) {
             if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
                 singularity_priv_escalate();
                 singularity_message(DEBUG, "Creating scratch directory inside container\n");
-                r = s_mkpath(full_destdir_path, 0755);
+                r = s_mkpath(full_destdir_path, 0755, container_dir);
                 singularity_priv_drop();
                 if ( r < 0 ) {
                     singularity_message(VERBOSE, "Skipping scratch directory mount, could not create dir inside container %s: %s\n", current, strerror(errno));
diff --git a/src/lib/runtime/mounts/tmp/tmp.c b/src/lib/runtime/mounts/tmp/tmp.c
index 5e8e94121..559e78960 100644
--- a/src/lib/runtime/mounts/tmp/tmp.c
+++ b/src/lib/runtime/mounts/tmp/tmp.c
@@ -81,7 +81,7 @@ int _singularity_runtime_mount_tmp(void) {
     }
 
     if ( check_mounted("/tmp") < 0 ) {
-        if ( s_mkpath(tmp_source, 0755) < 0 ) {
+        if ( s_mkpath(tmp_source, 0755, NULL) < 0 ) {
             singularity_message(ERROR, "Could not create source /tmp directory %s: %s\n", tmp_source, strerror(errno));
             ABORT(255);
         }
@@ -109,7 +109,7 @@ int _singularity_runtime_mount_tmp(void) {
     }
 
     if ( check_mounted("/var/tmp") < 0 ) {
-        if ( s_mkpath(vartmp_source, 0755) < 0 ) {
+        if ( s_mkpath(vartmp_source, 0755, NULL) < 0 ) {
             singularity_message(ERROR, "Could not create source /var/tmp directory %s: %s\n", vartmp_source, strerror(errno));
             ABORT(255);
         }
diff --git a/src/lib/runtime/mounts/userbinds/userbinds.c b/src/lib/runtime/mounts/userbinds/userbinds.c
index e6fea3055..c6785c66b 100644
--- a/src/lib/runtime/mounts/userbinds/userbinds.c
+++ b/src/lib/runtime/mounts/userbinds/userbinds.c
@@ -93,7 +93,6 @@ int _singularity_runtime_mount_userbinds(void) {
                 }
             }
 
-
             singularity_message(DEBUG, "Checking if bind point is already mounted: %s\n", dest);
             if ( check_mounted(dest) >= 0 ) {
                 singularity_message(WARNING, "Not mounting requested bind point (already mounted in container): %s\n", dest);
@@ -103,12 +102,17 @@ int _singularity_runtime_mount_userbinds(void) {
             if ( ( is_file(source) == 0 ) && ( is_file(joinpath(container_dir, dest)) < 0 ) ) {
                 if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
                     char *dir = dirname(strdup(dest));
+                    if ( strcmp(dir, "/") != 0 && check_mounted(dir) >= 0 ) {
+                        singularity_message(WARNING, "Nested bind detected, skip file creation\n");
+                        continue;
+                    }
+
                     if ( is_dir(joinpath(container_dir, dir)) < 0 ) {
                         singularity_message(VERBOSE3, "Creating bind directory on overlay file system: %s\n", dest);
-                        if ( s_mkpath(joinpath(container_dir, dir), 0755) < 0 ) {
+                        if ( s_mkpath(joinpath(container_dir, dir), 0755, container_dir) < 0 ) {
                             singularity_priv_escalate();
                             singularity_message(VERBOSE3, "Retrying with privileges to create bind directory on overlay file system: %s\n", dest);
-                            if ( s_mkpath(joinpath(container_dir, dir), 0755) < 0 ) {
+                            if ( s_mkpath(joinpath(container_dir, dir), 0755, container_dir) < 0 ) {
                                 singularity_message(ERROR, "Could not create basedir for file bind %s: %s\n", dest, strerror(errno));
                                 continue;
                             }
@@ -135,10 +139,10 @@ int _singularity_runtime_mount_userbinds(void) {
             } else if ( ( is_dir(source) == 0 ) && ( is_dir(joinpath(container_dir, dest)) < 0 ) ) {
                 if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
                     singularity_message(VERBOSE3, "Creating bind directory on overlay file system: %s\n", dest);
-                    if ( s_mkpath(joinpath(container_dir, dest), 0755) < 0 ) {
+                    if ( s_mkpath(joinpath(container_dir, dest), 0755, container_dir) < 0 ) {
                         singularity_priv_escalate();
                         singularity_message(VERBOSE3, "Retrying with privileges to create bind directory on overlay file system: %s\n", dest);
-                        if ( s_mkpath(joinpath(container_dir, dest), 0755) < 0 ) {
+                        if ( s_mkpath(joinpath(container_dir, dest), 0755, container_dir) < 0 ) {
                             singularity_priv_drop();
                             singularity_message(WARNING, "Skipping user bind, could not create bind point %s: %s\n", dest, strerror(errno));
                             continue;
diff --git a/src/lib/runtime/overlayfs/overlayfs.c b/src/lib/runtime/overlayfs/overlayfs.c
index d52258453..62995a0e7 100644
--- a/src/lib/runtime/overlayfs/overlayfs.c
+++ b/src/lib/runtime/overlayfs/overlayfs.c
@@ -51,7 +51,7 @@ int _singularity_runtime_overlayfs(void) {
 
     singularity_priv_escalate();
     singularity_message(DEBUG, "Creating overlay_final directory: %s\n", CONTAINER_FINALDIR);
-    if ( s_mkpath(CONTAINER_FINALDIR, 0755) < 0 ) {
+    if ( s_mkpath(CONTAINER_FINALDIR, 0755, NULL) < 0 ) {
         singularity_message(ERROR, "Failed creating overlay_final directory %s: %s\n", CONTAINER_FINALDIR, strerror(errno));
         ABORT(255);
     }
@@ -143,13 +143,13 @@ int _singularity_runtime_overlayfs(void) {
 
         singularity_priv_escalate();
         singularity_message(DEBUG, "Creating upper overlay directory: %s\n", overlay_upper);
-        if ( s_mkpath(overlay_upper, 0755) < 0 ) {
+        if ( s_mkpath(overlay_upper, 0755, overlay_mount) < 0 ) {
             singularity_message(ERROR, "Failed creating upper overlay directory %s: %s\n", overlay_upper, strerror(errno));
             ABORT(255);
         }
 
         singularity_message(DEBUG, "Creating overlay work directory: %s\n", overlay_work);
-        if ( s_mkpath(overlay_work, 0755) < 0 ) {
+        if ( s_mkpath(overlay_work, 0755, overlay_mount) < 0 ) {
             singularity_message(ERROR, "Failed creating overlay work directory %s: %s\n", overlay_work, strerror(errno));
             ABORT(255);
         }
diff --git a/src/util/daemon.c b/src/util/daemon.c
index b66c45fd2..2124960f1 100644
--- a/src/util/daemon.c
+++ b/src/util/daemon.c
@@ -151,7 +151,7 @@ void daemon_init_start(void) {
     
     /* Check if /var/tmp/.singularity-daemon-[UID]/ directory exists, if not create it */
     if ( is_dir(dirname(daemon_file_dir)) == -1 ) {
-        s_mkpath(daemon_file_dir, 0755);
+        s_mkpath(daemon_file_dir, 0755, NULL);
     }
     
     /* Attempt to open lock on daemon file */
diff --git a/src/util/file.c b/src/util/file.c
index 21aaa5045..de43001c7 100644
--- a/src/util/file.c
+++ b/src/util/file.c
@@ -281,7 +281,10 @@ int is_chr(char *path) {
 }
 
 
-int s_mkpath(char *dir, mode_t mode) {
+int s_mkpath(char *dir, mode_t mode, char *base) {
+    char *dupdir;
+    char *realdir;
+
     if (!dir) {
         return(-1);
     }
@@ -298,12 +301,33 @@ int s_mkpath(char *dir, mode_t mode) {
 
     if ( is_dir(dirname(strdupa(dir))) < 0 ) {
         singularity_message(DEBUG, "Creating parent directory: %s\n", dirname(strdupa(dir)));
-        if ( s_mkpath(dirname(strdupa(dir)), mode) < 0 ) {
+        if ( s_mkpath(dirname(strdupa(dir)), mode, base) < 0 ) {
             singularity_message(VERBOSE, "Failed to create parent directory %s\n", dir);
             return(-1);
         }
     }
 
+    if ( base != NULL ) {
+        dupdir = strdup(dir);
+        if ( dupdir == NULL ) {
+            singularity_message(ERROR, "Failed to allocate memory\n");
+            ABORT(255);
+        }
+        realdir = realpath(dirname(dupdir), NULL); // Flawfinder: ignore
+        if ( realdir == NULL ) {
+            singularity_message(ERROR, "A component of the path is missing\n");
+            ABORT(255);
+        }
+        if ( strncmp(base, realdir, strlen(base)) != 0 ) {
+            free(dupdir);
+            free(realdir);
+            singularity_message(WARNING, "Skip creation of path, attempt to create directory outside of %s\n", base);
+            return(-1);
+        }
+        free(dupdir);
+        free(realdir);
+    }
+
     singularity_message(DEBUG, "Creating directory: %s\n", dir);
     mode_t mask = umask(0); // Flawfinder: ignore
     int ret = mkdir(dir, mode);
diff --git a/src/util/file.h b/src/util/file.h
index d1629bbd4..6feaa856a 100644
--- a/src/util/file.h
+++ b/src/util/file.h
@@ -39,7 +39,7 @@ int is_suid(char *path);
 int is_owner(char *path, uid_t uid);
 int is_blk(char *path);
 int is_chr(char *path);
-int s_mkpath(char *dir, mode_t mode);
+int s_mkpath(char *dir, mode_t mode, char *base);
 int s_rmdir(char *dir);
 int copy_file(char * source, char * dest);
 char *filecat(char *path);
diff --git a/src/util/mount.c b/src/util/mount.c
index 9ab9aec16..42ff71246 100644
--- a/src/util/mount.c
+++ b/src/util/mount.c
@@ -36,6 +36,8 @@ int singularity_mount(const char *source, const char *target,
                       const char *filesystemtype, unsigned long mountflags,
                       const void *data) {
     int ret;
+    int mount_errno;
+
     uid_t fsuid = 0;
 
     if ( ( mountflags & MS_BIND ) ) {
@@ -52,11 +54,14 @@ int singularity_mount(const char *source, const char *target,
         setfsuid(fsuid);
     }
     ret = mount(source, target, filesystemtype, mountflags, data);
+    mount_errno = errno;
+
     if ( singularity_priv_userns_enabled() == 0 && seteuid(singularity_priv_getuid()) < 0 ) {
         singularity_message(ERROR, "Failed to drop privileges: %s\n", strerror(errno));
         ABORT(255);
     }
 
+    errno = mount_errno;
     return ret;
 }
 
@@ -67,6 +72,7 @@ int check_mounted(char *mountpoint) {
     char *rootfs_dir = CONTAINER_FINALDIR;
     unsigned int mountpoint_len = strlength(mountpoint, PATH_MAX);
     char *real_mountpoint;
+    char procmounts[PATH_MAX];
 
     singularity_message(DEBUG, "Opening /proc/mounts\n");
     if ( ( mounts = fopen("/proc/mounts", "r") ) == NULL ) { // Flawfinder: ignore
@@ -79,19 +85,29 @@ int check_mounted(char *mountpoint) {
         mountpoint[mountpoint_len-1] = '\0';
     }
 
-    real_mountpoint = realpath(mountpoint, NULL); // Flawfinder: ignore
+    real_mountpoint = realpath(joinpath(rootfs_dir, mountpoint), NULL); // Flawfinder: ignore
     if ( real_mountpoint == NULL ) {
-        // mountpoint doesn't exist
+        // mountpoint doesn't exists
         return(retval);
     }
 
+    if ( snprintf(procmounts, PATH_MAX-1, "%s/proc/%d/mounts", rootfs_dir, getpid()) < 0 ) {
+        singularity_message(ERROR, "Can't construct path %s/proc/%d/mounts\n", rootfs_dir, getpid());
+        ABORT(255);
+    }
+
+    if ( strcmp(real_mountpoint, procmounts) == 0 ) {
+        singularity_message(ERROR, "Attempt to override /proc/mounts, aborting\n");
+        ABORT(255);
+    }
+
     singularity_message(DEBUG, "Iterating through /proc/mounts\n");
     while ( fgets(line, MAX_LINE_LEN, mounts) != NULL ) {
         (void) strtok(strdup(line), " ");
         char *mount = strtok(NULL, " ");
 
         // Check to see if mountpoint is already mounted
-        if ( strcmp(joinpath(rootfs_dir, real_mountpoint), mount) == 0 ) {
+        if ( strcmp(real_mountpoint, mount) == 0 ) {
             singularity_message(DEBUG, "Mountpoint is already mounted: %s\n", mountpoint);
             retval = 1;
             break;

From 61dee67b242533a783fb4180be282b44114f7559 Mon Sep 17 00:00:00 2001
From: Cedric Clerget <cedric.clerget@gmail.com>
Date: Tue, 27 Mar 2018 23:02:02 +0200
Subject: [PATCH 2/4] Update CHANGELOG.md

---
 CHANGELOG.md | 1 +
 1 file changed, 1 insertion(+)

diff --git a/CHANGELOG.md b/CHANGELOG.md
index ec7a044a3..f0914522b 100644
--- a/CHANGELOG.md
+++ b/CHANGELOG.md
@@ -23,6 +23,7 @@ and changes prior to that are (unfortunately) done retrospectively. Critical ite
  - Adjustments to SCIF (Scientific Filesystem) integration for broader use
  - Fixed bug that did not export environment variables for apps with "-" in name
  - Fix conflict between `--nv` and `--contain` options
+ - Add checks for file/directory creation when overlay is enabled
 
 ## [v2.4.4](https://github.com/singularityware/singularity/tree/release-2.4)
 

From 828096a7a58ffb1712791288aa403357c8d0f331 Mon Sep 17 00:00:00 2001
From: Cedric Clerget <cedric.clerget@gmail.com>
Date: Wed, 28 Mar 2018 16:33:06 +0200
Subject: [PATCH 3/4] Fix nested binds level

---
 src/lib/runtime/mounts/binds/binds.c         | 35 +++++++++++++++++++++-------
 src/lib/runtime/mounts/userbinds/userbinds.c | 35 ++++++++++++++++++++--------
 2 files changed, 51 insertions(+), 19 deletions(-)

diff --git a/src/lib/runtime/mounts/binds/binds.c b/src/lib/runtime/mounts/binds/binds.c
index eed4f040b..a74a27d92 100644
--- a/src/lib/runtime/mounts/binds/binds.c
+++ b/src/lib/runtime/mounts/binds/binds.c
@@ -60,6 +60,9 @@ int _singularity_runtime_mount_binds(void) {
     while ( *tmp_config_string_list != NULL ) {
         tmp_config_string = strdup(*tmp_config_string_list);
         tmp_config_string_list++;
+        unsigned char nested = 0;
+        char *ptr;
+        char *dupdest;
         char *source = strtok(tmp_config_string, ":");
         char *dest = strtok(NULL, ":");
         chomp(source);
@@ -77,19 +80,33 @@ int _singularity_runtime_mount_binds(void) {
         }
 
         singularity_message(DEBUG, "Checking if bind point is already mounted: %s\n", dest);
-        if ( check_mounted(dest) >= 0 ) {
-            singularity_message(VERBOSE, "Not mounting bind point (already mounted): %s\n", dest);
+        dupdest = strdup(dest);
+        if ( strcmp(dest, "/") == 0 ) {
+            singularity_message(WARNING, "Attempt to bind %s to container root filesystem, bind point ignored\n", source);
             continue;
         }
 
-        if ( ( is_file(source) == 0 ) && ( is_file(joinpath(container_dir, dest)) < 0 ) ) {
+        if ( dupdest == NULL ) {
+            singularity_message(ERROR, "Failed to allocate memory\n");
+            ABORT(255);
+        }
+        for ( ptr = dupdest + 1; *ptr; ptr++ ) {
+            if ( *ptr == '/' ) {
+                *ptr = '\0';
+                if ( check_mounted(dupdest) >= 0 ) {
+                    singularity_message(WARNING, "Nested bind detected for %s, skip file/directory creation\n", dupdest);
+                    nested = 1;
+                    break;
+                }
+                *ptr = '/';
+            }
+        }
+        free(dupdest);
+
+
+        if ( nested == 0 && ( is_file(source) == 0 ) && ( is_file(joinpath(container_dir, dest)) < 0 ) ) {
             if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
                 char *basedir = dirname(joinpath(container_dir, dest));
-                char *dir = dirname(strdup(dest));
-                if ( strcmp(dir, "/") != 0 && check_mounted(dir) >= 0 ) {
-                    singularity_message(WARNING, "Nested bind detected, skip file creation\n");
-                    continue;
-                }
 
                 singularity_message(DEBUG, "Checking base directory for file %s ('%s')\n", dest, basedir);
                 if ( is_dir(basedir) != 0 ) {
@@ -121,7 +138,7 @@ int _singularity_runtime_mount_binds(void) {
                 singularity_message(WARNING, "Non existent bind point (file) in container: '%s'\n", dest);
                 continue;
             }
-        } else if ( ( is_dir(source) == 0 ) && ( is_dir(joinpath(container_dir, dest)) < 0 ) ) {
+        } else if ( nested == 0 && ( is_dir(source) == 0 ) && ( is_dir(joinpath(container_dir, dest)) < 0 ) ) {
             if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
                 singularity_priv_escalate();
                 singularity_message(VERBOSE3, "Creating bind directory on overlay file system: %s\n", dest);
diff --git a/src/lib/runtime/mounts/userbinds/userbinds.c b/src/lib/runtime/mounts/userbinds/userbinds.c
index c6785c66b..3f4d8e87d 100644
--- a/src/lib/runtime/mounts/userbinds/userbinds.c
+++ b/src/lib/runtime/mounts/userbinds/userbinds.c
@@ -70,6 +70,9 @@ int _singularity_runtime_mount_userbinds(void) {
 
         while ( current != NULL ) {
             int read_only = 0;
+            unsigned char nested = 0;
+            char *dir, *ptr;
+            char *dupdest;
             char *source = strtok_r(current, ":", &inside_token);
             char *dest = strtok_r(NULL, ":", &inside_token);
             char *opts = strtok_r(NULL, ":", &inside_token);
@@ -94,19 +97,31 @@ int _singularity_runtime_mount_userbinds(void) {
             }
 
             singularity_message(DEBUG, "Checking if bind point is already mounted: %s\n", dest);
-            if ( check_mounted(dest) >= 0 ) {
-                singularity_message(WARNING, "Not mounting requested bind point (already mounted in container): %s\n", dest);
+            dupdest = strdup(dest);
+            if ( dupdest == NULL ) {
+                singularity_message(ERROR, "Failed to allocate memory\n");
+                ABORT(255);
+            }
+            if ( strcmp(dest, "/") == 0 ) {
+                singularity_message(WARNING, "Attempt to bind %s to container root filesystem, bind point ignored\n", source);
                 continue;
             }
-
-            if ( ( is_file(source) == 0 ) && ( is_file(joinpath(container_dir, dest)) < 0 ) ) {
-                if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
-                    char *dir = dirname(strdup(dest));
-                    if ( strcmp(dir, "/") != 0 && check_mounted(dir) >= 0 ) {
-                        singularity_message(WARNING, "Nested bind detected, skip file creation\n");
-                        continue;
+            for ( ptr = dupdest + 1; *ptr; ptr++ ) {
+                if ( *ptr == '/' ) {
+                    *ptr = '\0';
+                    if ( check_mounted(dupdest) >= 0 ) {
+                        singularity_message(WARNING, "Nested bind detected for %s, skip file/directory creation\n", dupdest);
+                        nested = 1;
+                        break;
                     }
+                    *ptr = '/';
+                }
+            }
+            free(dupdest);
 
+            if ( nested == 0 && ( is_file(source) == 0 ) && ( is_file(joinpath(container_dir, dest)) < 0 ) ) {
+                if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
+                    dir = dirname(strdup(dest));
                     if ( is_dir(joinpath(container_dir, dir)) < 0 ) {
                         singularity_message(VERBOSE3, "Creating bind directory on overlay file system: %s\n", dest);
                         if ( s_mkpath(joinpath(container_dir, dir), 0755, container_dir) < 0 ) {
@@ -136,7 +151,7 @@ int _singularity_runtime_mount_userbinds(void) {
                     singularity_message(WARNING, "Skipping user bind, non existent bind point (file) in container: '%s'\n", dest);
                     continue;
                 }
-            } else if ( ( is_dir(source) == 0 ) && ( is_dir(joinpath(container_dir, dest)) < 0 ) ) {
+            } else if ( nested == 0 && ( is_dir(source) == 0 ) && ( is_dir(joinpath(container_dir, dest)) < 0 ) ) {
                 if ( singularity_registry_get("OVERLAYFS_ENABLED") != NULL ) {
                     singularity_message(VERBOSE3, "Creating bind directory on overlay file system: %s\n", dest);
                     if ( s_mkpath(joinpath(container_dir, dest), 0755, container_dir) < 0 ) {

From 2898493aeaf6822099f789750017e96a52841ec7 Mon Sep 17 00:00:00 2001
From: Cedric Clerget <cedric.clerget@gmail.com>
Date: Thu, 29 Mar 2018 01:34:18 +0200
Subject: [PATCH 4/4] Fix regression for OVERLAYFS_ENABLED registry key. Modify
 order of mount stages. Add checks in singularity_mount to verify that target
 mount point is in an allowed path.

---
 src/lib/runtime/mounts/mounts.c       |  4 ++--
 src/lib/runtime/overlayfs/overlayfs.c |  1 +
 src/util/mount.c                      | 40 +++++++++++++++++++++++++++++++++--
 3 files changed, 41 insertions(+), 4 deletions(-)

diff --git a/src/lib/runtime/mounts/mounts.c b/src/lib/runtime/mounts/mounts.c
index fe2fa32d0..a19cf410b 100644
--- a/src/lib/runtime/mounts/mounts.c
+++ b/src/lib/runtime/mounts/mounts.c
@@ -54,10 +54,10 @@ int _singularity_runtime_mounts(void) {
     retval += _singularity_runtime_mount_kernelfs();
     retval += _singularity_runtime_mount_dev();
     retval += _singularity_runtime_mount_home();
-    retval += _singularity_runtime_mount_userbinds();
-    retval += _singularity_runtime_mount_tmp();
     retval += _singularity_runtime_mount_scratch();
+    retval += _singularity_runtime_mount_tmp();
     retval += _singularity_runtime_mount_cwd();
+    retval += _singularity_runtime_mount_userbinds();
 
     return(retval);
 }
diff --git a/src/lib/runtime/overlayfs/overlayfs.c b/src/lib/runtime/overlayfs/overlayfs.c
index 62995a0e7..eb9049909 100644
--- a/src/lib/runtime/overlayfs/overlayfs.c
+++ b/src/lib/runtime/overlayfs/overlayfs.c
@@ -48,6 +48,7 @@
 
 
 int _singularity_runtime_overlayfs(void) {
+    singularity_registry_set("OVERLAYFS_ENABLED", NULL);
 
     singularity_priv_escalate();
     singularity_message(DEBUG, "Creating overlay_final directory: %s\n", CONTAINER_FINALDIR);
diff --git a/src/util/mount.c b/src/util/mount.c
index 42ff71246..8a1d51349 100644
--- a/src/util/mount.c
+++ b/src/util/mount.c
@@ -13,6 +13,7 @@
  * 
 */
 
+#define _GNU_SOURCE
 #include <errno.h>
 #include <fcntl.h>
 #include <stdio.h>
@@ -23,6 +24,7 @@
 #include <unistd.h>
 #include <stdlib.h>
 #include <limits.h>
+#include <libgen.h>
 
 #include "config.h"
 #include "util/file.h"
@@ -37,13 +39,43 @@ int singularity_mount(const char *source, const char *target,
                       const void *data) {
     int ret;
     int mount_errno;
-
     uid_t fsuid = 0;
+    char dest[PATH_MAX];
+    char *realdest;
+    int target_fd = open(target, O_RDONLY);
+
+    if ( target_fd < 0 ) {
+        singularity_message(ERROR, "Target %s doesn't exist\n", target);
+        ABORT(255);
+    }
+
+    if ( snprintf(dest, PATH_MAX-1, "/proc/self/fd/%d", target_fd) < 0 ) {
+        singularity_message(ERROR, "Failed to determine path for target file descriptor\n");
+        ABORT(255);
+    }
 
     if ( ( mountflags & MS_BIND ) ) {
         fsuid = singularity_priv_getuid();
     }
 
+    realdest = realpath(dest, NULL); // Flawfinder: ignore
+    if ( realdest == NULL ) {
+        singularity_message(ERROR, "Failed to get real path of %s %s\n", target, dest);
+        ABORT(255);
+    }
+
+    if ( (mountflags & MS_PRIVATE) == 0 && (mountflags & MS_SLAVE) == 0 ) {
+        if ( strncmp(realdest, CONTAINER_MOUNTDIR, strlen(CONTAINER_MOUNTDIR)) != 0 &&
+             strncmp(realdest, CONTAINER_FINALDIR, strlen(CONTAINER_FINALDIR)) != 0 &&
+             strncmp(realdest, CONTAINER_OVERLAY, strlen(CONTAINER_OVERLAY)) != 0 &&
+             strncmp(realdest, SESSIONDIR, strlen(SESSIONDIR)) != 0 ) {
+            singularity_message(VERBOSE, "Ignored, try to mount %s outside of container %s\n", target, realdest);
+            free(realdest);
+            close(target_fd);
+            return(0);
+        }
+    }
+
     /* don't modify user groups */
     if ( singularity_priv_userns_enabled() == 0 ) {
         if ( seteuid(0) < 0 ) {
@@ -53,9 +85,13 @@ int singularity_mount(const char *source, const char *target,
         /* NFS root_squash option set uid 0 to nobody, force use of real user ID */
         setfsuid(fsuid);
     }
-    ret = mount(source, target, filesystemtype, mountflags, data);
+
+    ret = mount(source, dest, filesystemtype, mountflags, data);
     mount_errno = errno;
 
+    close(target_fd);
+    free(realdest);
+
     if ( singularity_priv_userns_enabled() == 0 && seteuid(singularity_priv_getuid()) < 0 ) {
         singularity_message(ERROR, "Failed to drop privileges: %s\n", strerror(errno));
         ABORT(255);
