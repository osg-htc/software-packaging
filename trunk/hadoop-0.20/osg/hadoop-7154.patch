--- bin/hadoop-config.sh.orig	2012-12-19 10:21:37.000000000 -0600
+++ bin/hadoop-config.sh	2012-12-19 10:39:45.000000000 -0600
@@ -108,6 +108,14 @@
   fi
 fi
 
+# Newer versions of glibc use an arena memory allocator that causes virtual
+# memory usage to explode. This interacts badly with the many threads that
+# we use in Hadoop. Tune the variable down to prevent vmem explosion.
+export MALLOC_ARENA_MAX=${MALLOC_ARENA_MAX:-4}
+
+# Also, add more user processes to avoid hitting virtual memory explosion
+ulimit -u 8192
+
 if [ -d $HADOOP_HOME/pids ]; then
 HADOOP_PID_DIR="${HADOOP_PID_DIR:-$HADOOP_HOME/pids}"
 fi
