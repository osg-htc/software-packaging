From d1456be8cb8127fa5856a811be7681abf7e11d08 Mon Sep 17 00:00:00 2001
From: Matyas Selmeci <matyas@cs.wisc.edu>
Date: Fri, 1 May 2020 11:39:03 -0500
Subject: [PATCH 1/3] Extract calling source_cmd from BuildRoot.build_srpm(),
 so we can call it separately in other places.

---
 builder/kojid | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/builder/kojid b/builder/kojid
index 9f7c2f9..d1f8bea 100755
--- a/builder/kojid
+++ b/builder/kojid
@@ -585,6 +585,18 @@ class BuildRoot(object):
             self.expire()
             raise koji.BuildError("error building srpm, %s" % self._mockResult(rv))
 
+    def scm_call_source_cmd(self, sourcedir, source_cmd):
+        """call the command defined by source_cmd in the chroot so any required files not stored in
+        the SCM can be retrieved
+        """
+        chroot_sourcedir = sourcedir[len(self.rootdir()):]
+        args = ['--no-clean', '--unpriv', '--cwd', chroot_sourcedir, '--chroot']
+        args.extend(source_cmd)
+        rv = self.mock(args)
+        if rv:
+            self.expire()
+            raise koji.BuildError("error retrieving sources, %s" % self._mockResult(rv))
+
 
     def build_srpm(self, specfile, sourcedir, source_cmd):
         self.session.host.setBuildRootState(self.id,'BUILDING')
-- 
2.6.3


From 835357ab30838358be2a4fc07047ffab429d6b89 Mon Sep 17 00:00:00 2001
From: Matyas Selmeci <matyas@cs.wisc.edu>
Date: Fri, 1 May 2020 11:41:31 -0500
Subject: [PATCH 2/3] Replace running source command in BuildRoot.build_srpm()
 with call to BuildRoot.scm_call_source_cmd().

---
 builder/kojid | 10 +---------
 1 file changed, 1 insertion(+), 9 deletions(-)

diff --git a/builder/kojid b/builder/kojid
index d1f8bea..cffd425 100755
--- a/builder/kojid
+++ b/builder/kojid
@@ -601,15 +601,7 @@ class BuildRoot(object):
     def build_srpm(self, specfile, sourcedir, source_cmd):
         self.session.host.setBuildRootState(self.id,'BUILDING')
         if source_cmd:
-            # call the command defined by source_cmd in the chroot so any required files not stored in
-            # the SCM can be retrieved
-            chroot_sourcedir = sourcedir[len(self.rootdir()):]
-            args = ['--no-clean', '--unpriv', '--cwd', chroot_sourcedir, '--chroot']
-            args.extend(source_cmd)
-            rv = self.mock(args)
-            if rv:
-                self.expire()
-                raise koji.BuildError("error retrieving sources, %s" % self._mockResult(rv))
+            self.scm_call_source_cmd(sourcedir, source_cmd)
 
         alt_sources_dir = "%s/SOURCES" % sourcedir
         if self.options.support_rpm_source_layout and os.path.isdir(alt_sources_dir):
-- 
2.6.3


From d0816643d58f8e59ea69dc8cff99df1ef501c3df Mon Sep 17 00:00:00 2001
From: Matyas Selmeci <matyas@cs.wisc.edu>
Date: Fri, 1 May 2020 11:45:30 -0500
Subject: [PATCH 3/3] Run BuildRoot.scm_call_source_cmd() before checking for
 spec file existence in BuildSRPMFromSCMTask.handler(), in case the source_cmd
 fetches the spec file.

Change the later call to BuildRoot.build_srpm() to not run the source_cmd a second time.
---
 builder/kojid | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/builder/kojid b/builder/kojid
index cffd425..66b2114 100755
--- a/builder/kojid
+++ b/builder/kojid
@@ -4809,6 +4809,10 @@ class BuildSRPMFromSCMTask(BaseBuildTask):
         # Hook for patching spec file in place
         self.patch_scm_source(sourcedir, logfile, opts)
 
+        # Run the source_cmd; do this before checking for spec file(s) in case
+        # source_cmd creates them.
+        if scm.source_cmd:
+            broot.scm_call_source_cmd(sourcedir, scm.source_cmd)
         # Find and verify that there is only one spec file.
         spec_files = glob.glob("%s/*.spec" % sourcedir)
         if not spec_files and self.options.support_rpm_source_layout:
@@ -4827,9 +4827,9 @@ class BuildSRPMFromSCMTask(BaseBuildTask):
         # Run spec file sanity checks.  Any failures will throw a BuildError
         self.spec_sanity_checks(spec_file)
 
-        #build srpm
+        #build srpm; we already ran source_cmd once, don't do it again.
         self.logger.debug("Running srpm build")
-        broot.build_srpm(spec_file, sourcedir, scm.source_cmd)
+        broot.build_srpm(spec_file, sourcedir, source_cmd=None)
 
         srpms = glob.glob('%s/*.src.rpm' % broot.resultdir())
         if len(srpms) == 0:
-- 
2.6.3

