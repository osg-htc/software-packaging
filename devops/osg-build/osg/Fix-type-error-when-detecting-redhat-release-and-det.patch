From 97ef5e4dc724c5875d57f16f40485b38189b1e06 Mon Sep 17 00:00:00 2001
From: Matyas Selmeci <matyas@cs.wisc.edu>
Date: Tue, 30 Jun 2020 10:06:18 -0500
Subject: [PATCH] Fix type error when detecting redhat release and detect
 fedora

---
 osgbuild/mock.py  |  2 +-
 osgbuild/utils.py | 24 ++++++++++++++++--------
 2 files changed, 17 insertions(+), 9 deletions(-)

diff --git a/osgbuild/mock.py b/osgbuild/mock.py
index 17390b0..c09d2af 100644
--- a/osgbuild/mock.py
+++ b/osgbuild/mock.py
@@ -143,7 +143,7 @@ def rebuild(self, resultdir, srpm):
         if self.mock_version >= (1,4,0):
             # systemd-nspawn is often broken; don't use it. network is required for maven builds :(
             rebuild_cmd += ['--enable-network', '--config-opts=use_nspawn=False']
-            if int(self.buildopts["redhat_release"]) >= 8 and utils.get_local_machine_dver() < 8:
+            if int(self.buildopts["redhat_release"]) >= 8 and utils.get_local_machine_dver() < "el8":
                 rebuild_cmd += ["--bootstrap-chroot"]
         else:
             # ccache on old versions tries to install the el5 package for ccache and dies
diff --git a/osgbuild/utils.py b/osgbuild/utils.py
index f8fe5bd..abb395a 100644
--- a/osgbuild/utils.py
+++ b/osgbuild/utils.py
@@ -462,16 +462,24 @@ def popd():
 
 
 def get_local_machine_dver():
-    "Return the distro version (e.g. 'el6', 'el7') of the local machine or None"
+    # type: () -> str
+    """Return the distro version (e.g. 'el6', 'el7') of the local machine
+    or the empty string if we can't figure it out."""
     try:
         redhat_release_contents = slurp("/etc/redhat-release")
-    except EnvironmentError: # some error reading the file
-        return
+        if not redhat_release_contents:
+            return ""  # empty file?
+    except EnvironmentError:  # some error reading the file
+        return ""
 
     for rhellike in ["Scientific", "Red Hat Enterprise", "CentOS"]:
-        try:
-            if rhellike in redhat_release_contents:
-                match = re.search(r"release (\d+)", redhat_release_contents)
+        if rhellike in redhat_release_contents:
+            match = re.search(r"release (\d+)", redhat_release_contents)
+            if match:
                 return "el" + match.group(1)
-        except (TypeError, AttributeError): # empty file or no match
-            return
+            else:
+                return ""
+    match = re.search(r"Fedora release (\d+)", redhat_release_contents)
+    if match:
+        return "fc" + match.group(1)
+    return ""
-- 
2.6.3

